<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sushi Price Calculator</title>
  <meta name="theme-color" content="#e74c3c">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('Service worker updated.');
        });
      });
    }
  </script>
  <style>
    :root { --accent:#e74c3c; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #fafafa;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 10px 16px;
    }
    h1 { margin: 0; font-size: 1.2rem; }
    .settings-btn {
      position: absolute; right: 12px; top: 8px;
      border: none; background: transparent; font-size: 1.4rem; cursor: pointer;
    }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px 12px; }
    .plate {
      width: 100%; aspect-ratio: 1 / 1; border-radius: 50%;
      font-size: 1rem; border: none; cursor: pointer; color: white;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      background-size: cover; background-position: center;
    }
    .plate:active { transform: scale(0.96); }
    .red { background-color: #e74c3c; }
    .grey { background-color: #7f8c8d; }
    .gold { background-color: #f1c40f; color: #000; }
    .black { background-color: #2c3e50; }
    .custom { margin: 6px 12px 0; display: flex; gap: 8px; justify-content: center; }
    .custom input { width: 110px; padding: 8px; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; background: #fff; }
    .custom button { padding: 8px 12px; font-size: 1rem; border: none; border-radius: 6px; background: #27ae60; color: white; cursor: pointer; }
    .utility { display: flex; justify-content: center; gap: 10px; margin: 6px 0 4px; }
    .utility button { padding: 8px 12px; font-size: 0.95rem; border: none; border-radius: 6px; background: #2980b9; color: white; cursor: pointer; }
    .summary { flex: 1; overflow-y: auto; padding: 10px 12px 70px; border-top: 1px solid #eaeaea; background: #fff; margin-top: 4px; }
    .row { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eee; }
    .muted { color:#666; font-size:0.9rem; }
    .totals { position: fixed; bottom: 0; left: 0; right: 0; padding: 10px 12px; background: #f9f9f9; border-top: 2px solid #333; text-align: center; font-size: 1.05rem; z-index: 10; }
    .drawer { position: fixed; top: 0; right: 0; bottom: 0; width: 92%; max-width: 420px; background: #ffffff; box-shadow: -2px 0 12px rgba(0,0,0,0.15); transform: translateX(100%); transition: transform 0.25s ease; z-index: 50; display:flex; flex-direction:column; }
    .drawer.open { transform: translateX(0); }
    .drawer header { display:flex; align-items:center; justify-content:space-between; padding: 14px 16px; border-bottom:1px solid #eee; }
    .drawer h2 { margin:0; font-size:1.1rem; }
    .drawer .content { padding: 12px 16px; overflow-y:auto; }
    .toggle { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .upload-row { display:grid; grid-template-columns: 56px 1fr; gap:12px; align-items:center; padding:10px 0; border-bottom:1px solid #f1f1f1; }
    .thumb { width:56px; height:56px; border-radius:8px; background:#f3f3f3; background-size:cover; background-position:center; border:1px solid #ddd; }
    .row-title { font-weight:600; }
    .reset-btn { margin-top: 10px; padding: 8px 12px; background:#b33939; border:none; color:#fff; border-radius:6px; cursor:pointer; }
    .close-btn { border:none; background:transparent; font-size:1.4rem; cursor:pointer; }
    .small { font-size:0.85rem; color:#666; }
  </style>
</head>
<body>
  <header>
    <h1>üç£ Sushi Price Calculator</h1>
    <button class="settings-btn" id="openSettings" aria-label="Open settings">‚öôÔ∏è</button>
  </header>

  <div class="grid">
    <button class="plate red" id="btn-red"   onclick="addPlate(2.30, 'Red Plate')">üç£ $2.30</button>
    <button class="plate grey" id="btn-grey"  onclick="addPlate(2.90, 'Grey Plate')">üç£ $2.90</button>
    <button class="plate gold" id="btn-gold"  onclick="addPlate(3.90, 'Gold Plate')">üç£ $3.90</button>
    <button class="plate black" id="btn-black" onclick="addPlate(4.90, 'Black Plate')">üç£ $4.90</button>
  </div>

  <div class="custom">
    <input type="number" id="customPrice" step="0.01" placeholder="Custom $" />
    <button onclick="addCustom()">Add</button>
  </div>

  <div class="utility">
    <button onclick="removeLast()">‚Ü©Ô∏è Remove Last Plate</button>
    <button onclick="resetAll()">üîÑ Reset</button>
  </div>

  <div class="summary" id="summary">
    <div class="muted">No plates added yet.</div>
  </div>

  <div class="totals" id="totals">Total: $0.00</div>

  <aside class="drawer" id="drawer">
    <header>
      <h2>Settings</h2>
      <button class="close-btn" id="closeSettings" aria-label="Close settings">‚úñÔ∏è</button>
    </header>
    <div class="content">
      <div class="toggle">
        <div>
          <div class="row-title">Use placeholder images on buttons</div>
          <div class="small">When ON, plate buttons show images instead of plain colors.</div>
        </div>
        <label><input type="checkbox" id="togglePlaceholders"></label>
      </div>

      <div class="small" style="margin:8px 0 12px;">Upload custom images (PNG/JPG). They‚Äôre saved locally and work offline.</div>

      <div class="upload-row">
        <div class="thumb" id="preview-red"></div>
        <div>
          <div class="row-title">Red Plate</div>
          <input type="file" id="upload-red" accept="image/*">
        </div>
      </div>

      <div class="upload-row">
        <div class="thumb" id="preview-grey"></div>
        <div>
          <div class="row-title">Grey Plate</div>
          <input type="file" id="upload-grey" accept="image/*">
        </div>
      </div>

      <div class="upload-row">
        <div class="thumb" id="preview-gold"></div>
        <div>
          <div class="row-title">Gold Plate</div>
          <input type="file" id="upload-gold" accept="image/*">
        </div>
      </div>

      <div class="upload-row">
        <div class="thumb" id="preview-black"></div>
        <div>
          <div class="row-title">Black Plate</div>
          <input type="file" id="upload-black" accept="image/*">
        </div>
      </div>

      <button class="reset-btn" id="resetDefaults">Reset placeholders to defaults</button>
    </div>
  </aside>

  <script>
    const DEFAULT_IMAGES = {
      red: 'assets/plate-red.png',
      grey: 'assets/plate-grey.png',
      gold: 'assets/plate-gold.png',
      black: 'assets/plate-black.png'
    };
    const STORAGE_KEYS = {
      usePlaceholders: 'usePlaceholders',
      customImages: 'customImages',
      history: 'history'
    };

    let history = JSON.parse(localStorage.getItem(STORAGE_KEYS.history) || '[]');
    function saveHistory(){ localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(history)); }

    function applyPlaceholderImages() {
      const use = document.getElementById('togglePlaceholders').checked;
      const custom = JSON.parse(localStorage.getItem(STORAGE_KEYS.customImages) || '{}');
      const imgs = {
        red: custom.red || DEFAULT_IMAGES.red,
        grey: custom.grey || DEFAULT_IMAGES.grey,
        gold: custom.gold || DEFAULT_IMAGES.gold,
        black: custom.black || DEFAULT_IMAGES.black
      };
      const map = {
        red: document.getElementById('btn-red'),
        grey: document.getElementById('btn-grey'),
        gold: document.getElementById('btn-gold'),
        black: document.getElementById('btn-black')
      };
      Object.keys(map).forEach(key => {
        const btn = map[key];
        if (use) {
          btn.style.backgroundImage = `url('${imgs[key]}')`;
          btn.textContent = '';
        } else {
          btn.style.backgroundImage = 'none';
          const prices = {red:'$2.30', grey:'$2.90', gold:'$3.90', black:'$4.90'};
          btn.textContent = 'üç£ ' + prices[key];
        }
      });
      ['red','grey','gold','black'].forEach(key => {
        const el = document.getElementById('preview-' + key);
        el.style.backgroundImage = `url('${imgs[key]}')`;
      });
      localStorage.setItem(STORAGE_KEYS.usePlaceholders, use ? '1' : '0');
    }

    function addPlate(price, label) {
      history.push({price, label});
      saveHistory();
      updateSummary();
    }
    function addCustom() {
      const input = document.getElementById('customPrice');
      const v = parseFloat(input.value);
      if (!isNaN(v) && v > 0) {
        history.push({price:v, label:'Custom Item'});
        input.value='';
        saveHistory();
        updateSummary();
      }
    }
    function removeLast() {
      if (history.length>0) { history.pop(); saveHistory(); updateSummary(); }
    }
    function resetAll() { history = []; saveHistory(); updateSummary(); }

    function updateSummary() {
      const container = document.getElementById('summary');
      if (history.length === 0) {
        container.innerHTML = '<div class="muted">No plates added yet.</div>';
        document.getElementById('totals').textContent = 'Total: $0.00';
        return;
      }
      const grouped = {};
      history.forEach(item => {
        const key = item.label + '_' + item.price;
        if (!grouped[key]) grouped[key] = {label:item.label, price:item.price, count:0};
        grouped[key].count++;
      });
      container.innerHTML = '';
      let subtotal = 0;
      Object.values(grouped).forEach(item => {
        const line = item.count * item.price;
        subtotal += line;
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `<div>${item.label} √ó ${item.count}</div><div>$${line.toFixed(2)}</div>`;
        container.appendChild(row);
      });
      const service = subtotal * 0.10;
      const afterService = subtotal + service;
      const gst = afterService * 0.09;
      const total = afterService + gst;
      document.getElementById('totals').textContent =
        `Subtotal: $${subtotal.toFixed(2)} | +Svc: $${service.toFixed(2)} | +GST: $${gst.toFixed(2)} | Final: $${total.toFixed(2)}`;
    }

    const drawer = document.getElementById('drawer');
    document.getElementById('openSettings').addEventListener('click', ()=> drawer.classList.add('open'));
    document.getElementById('closeSettings').addEventListener('click', ()=> drawer.classList.remove('open'));

    const savedToggle = localStorage.getItem('usePlaceholders');
    document.getElementById('togglePlaceholders').checked = savedToggle === '1';

    function handleUpload(inputId, key){
      const input = document.getElementById(inputId);
      input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const custom = JSON.parse(localStorage.getItem('customImages') || '{}');
          custom[key] = reader.result;
          localStorage.setItem('customImages', JSON.stringify(custom));
          applyPlaceholderImages();
        };
        reader.readAsDataURL(file);
      });
    }
    handleUpload('upload-red','red');
    handleUpload('upload-grey','grey');
    handleUpload('upload-gold','gold');
    handleUpload('upload-black','black');

    document.getElementById('resetDefaults').addEventListener('click', ()=>{
      localStorage.removeItem('customImages');
      applyPlaceholderImages();
    });
    document.getElementById('togglePlaceholders').addEventListener('change', applyPlaceholderImages);

    applyPlaceholderImages();
    updateSummary();

    // Example to add extra assets to SW cache later:
    // navigator.serviceWorker?.ready.then(reg => {
    //   reg.active?.postMessage({type:'cache-add', urls:['assets/another-image.png']});
    // });
  </script>
</body>
</html>
